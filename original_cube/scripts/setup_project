#!/bin/bash
#
# $Id: setup_project 9 2003-02-12 01:57:52Z brc $
# $Log$
# Revision 1.1  2003/02/12 01:57:52  brc
# Scripts used to synchronise the running of CUBE and friends in
# the NOAA mold.
#
#
# File:		setup_project
# Purpose:	Set up component directories and configuration scripts for a
#		real-time run of CUBE
# Date:		18 August 2002
#

START=`date --utc +"%H:%M:%S %d %b %Y"`
echo "$START: start setup_project: $*" >>./libccom.log

fin=0
while [ $fin -eq 0 ]
do
	case $1 in
		-p)		PLATFORMS=$2;
				shift; shift;
				platset=1;
				;;
		-i)		INITGUTM=$2;
				shift; shift;
				;;
		*)		fin=1
				;;
	esac
done

if [ $# -ne 5 ]
then
	echo "Syntax: setup_project [opt] <base><project><raw><zone><init>"
	echo " Directory for project --------^      ^      ^     ^     ^"
	echo " Project name ------------------------'      |     |     |"
	echo " Location of raw data for project -----------'     |     |"
	echo " UTM Zone to work in ------------------------------'     |"
	echo " Initialisation parameter file --------------------------'"
	echo " Options:"
	echo "  -p PLATFORMS  Specify list of survey platforms being used"
	echo "  -i INITGUTM   Specify GUTM to be used for initialisation"
	exit 1
fi

BASE=$1
PROJECT=$2
RAWDIR=$3
UTMZONE=$4
INITPAR=$5

if [ ! -d $BASE ]
then
	echo "Error: the base directory ${BASE} must exist prior to running"
	echo "       this script (project will be made beneath it)."
	exit 1
fi

mkdir -p ${BASE}/${PROJECT}
NTBASE=${BASE}\\${PROJECT}	# Needed for makecari, which is native NT
BASE=${BASE}/${PROJECT}

# Make the HDCS hierarchy
mkdir -p ${BASE}/HDCS_Data/${PROJECT}
mkdir -p ${BASE}/Fieldsheets/${PROJECT}
mkdir -p ${BASE}/Tide
mkdir -p ${BASE}/Svp
mkdir -p ${BASE}/Session
mkdir -p ${BASE}/PointData
mkdir -p ${BASE}/PreProcess
mkdir -p ${BASE}/HDCS_Data/VesselConfig
mkdir -p ${BASE}/HDCS_Data/Config
if [ -f C:/CARIS/Hips/Config/Tai-utc ]
then
	cp C:/CARIS/Hips/Config/Tai-utc ${BASE}/HDCS_Data/Config
fi

# Make the project definition and configuration files.
NOW=`date --utc +"%k:%M %d/%m/%Y"`
cat >${BASE}/HDCS_Data/${PROJECT}/${PROJECT}.hpf <<- EOF
	[HIPS PROJECT DEFINITION VERSION 1.00]
	#WARNING: Do not edit this file.

	[PROJECT INFORMATION]
	HYDROGRAPHER = CUBE
	CREATION DATE = $NOW
	
	[PROJECT DATA]
	PROJECTION = AUTO_UTM,AUTO_UTM
	SW CORNER = -180.000000,-90.000000
	NE CORNER = 180.000000,90.000000
	EOF

# Make the processing hierarchy
mkdir -p ${BASE}/processing/{config,lists,sdfs,init,products}
mkdir -p ${BASE}/processing/gz3d/{gutm,clut,sdv}
mkdir -p ${BASE}/processing/sheets/{perday,cumulative}

# Copy the initialisation file into the local directory structure
if [ ! -f ${INITPAR} ]
then
	echo "Error: the initialisation file ${INITPAR} does not exist!"
	exit 1
fi
cp ${INITPAR} ${BASE}/processing/config
baseinitparam=`basename ${INITPAR}`

# Generate the summary information into the setup scripts for the project
if [ -f C:/CARIS/System/Datum.dat ]
then
	CARISDATUM=C:\\CARIS\\System\\Datum.dat
elif [ -f D:/CARIS/System/Datum.dat ]
then
	CARISDATUM=D:\\CARIS\\System\\Datum.dat
else
	CARISDATUM=UNKNOWN
	echo "Warning: Your CARIS installation was not detected during project"
	echo "         setup (Datum.dat was not found in C:/CARIS or D:/CARIS)."
	echo "         You will have to edit the \${BASE}/processing/config/setup"
	echo "         file after this script completes (GZTIOINIT variable) to"
	echo "         point the rest of the scripts in the right direction."
fi
if [ -d C:/Temp ]
then
	CARISTEMP=C:\\Temp
else
	CARISTEMP=UNKNOWN
	echo "Warning: Could not find a temp file directory as C:/Temp.  You will"
	echo "         have to edit the \${BASE}/processing/config/setup file"
	echo "         after this script completes (GZIOINIT variable) to point"
	echo "         the rest of the scripts in the right direction."
fi

DST=${BASE}/processing/config/setup
baseinitpar=`basename ${INITPAR}`
NOW=`date --utc`
cat >${DST} <<- EOF
	# Constructed by setup_project at $NOW
	RAWDIR="${RAWDIR}"
	BASE="${BASE}"
	NTBASE="${NTBASE}"
	PROJECT="${PROJECT}"
	PROCDIR="${BASE}/processing"
	INITDIR="${BASE}/processing/init"
	CONFIGDIR="${BASE}/processing/config"
	SHEETDIR="${BASE}/processing/sheets"
	SDFDIR="${BASE}/processing/sdfs"
	DEPTHGATE="2,350"
	ANGLEGATE="-60,60"
	IHOORDER="1"
	UTMZONE="${UTMZONE}"
	SENSOR="UNKNOWN"
	GUTMDIR="${BASE}/processing/gz3d/gutm"
	CLUTDIR="${BASE}/processing/gz3d/clut"
	SDVDIR="${BASE}/processing/gz3d/sdv"
	LISTDIR="${BASE}/processing/lists"
	SHEETLIST="perday cumulative"
	INITPAR="${BASE}/processing/config/${baseinitpar}"
	PLATSPEC="${BASE}/processing/config/${PROJECT}.psf"
	POINTDATADIR="${BASE}/PointData"
	GZTIOINIT="${NTBASE}\\HDCS_Data ${CARISDATUM} ${CARISTEMP}"
	SCRIPTSDIR="C:/Users/brc/Projects/scripts"

	export RAWDIR BASE PROJECT PROCDIR INITDIR CONFIGDIR SHEETDIR
	export SDFDIR DEPTHGATE ANGLEFATE SENSOR GUTMDIR CLUTDIR SDVDIR
	export LISTDIR SHEETLIST INITPAR PLATSPEC POINTDATADIR GZTIOINIT
	export SCRIPTSDIR
	EOF
	
MBDST=${BASE}/processing/config/mbsetup.def
cat >${MBDST} <<-EOF
	UTMZONE="${UTMZONE}"
	POINTDATADIR="${BASE}/PointData"
	EOF

if [ ! ${platset:-x} == "x" ]
then
	echo "export PLATFORMS=\"${PLATFORMS}\"" >>${DST}
	PDST=${BASE}/processing/config/${PROJECT}.psf
	for plat in $PLATFORMS
	do
		mkdir -p ${BASE}/HDCS_Data/${PROJECT}/${plat}
		NOW=`date --utc`
		cat >${BASE}/processing/config/setup.${plat} <<- EOF
			# Constructed by setup_project at $NOW
			PARAMFILE=${BASE}/processing/config/${plat}.par
			DEPTHGATE=2,350
			ANGLEGATE=-60,60
			SENSOR=UNKNOWN
			EOF
		
		echo "${plat} SENSOR ${BASE}/processing/config/${plat}.par" >>${PDST}
	done
else
	echo "export PLATFORMS=\"UNKNOWN\"" >>${DST}
fi

if [ ! ${INITGUTM:-x} == "x" ]
then
	baseinit=`basename ${INITGUTM}`
	echo "setup_project: copying initialisation GUTM to project ..."
	cp ${INITGUTM} ${BASE}/processing/init
	echo "setup_project: computing SDFs to cover work area ..."
	makesheets -l 1.0,5.0 -m 3000 -r 10.0 ${BASE}/processing ${baseinit} ${UTMZONE}
	# N.B.: We now do little work here, because we use the init_project code to complete
	# the initialisation after the user has had a chance to examine and rectify the
	# SDFs generated by makesheets.
	echo "export INITSURF=${BASE}/processing/init/${baseinit}" >>${DST}
else
	echo "export INITSURF=UNKNOWN" >>${DST}
fi

# Remind the user of the tasks still required to complete setup
echo "Info: setup_project completed normally.  Some tasks remain:"
echo "      1. Build a configuration file for each survey platform in"
echo "         ${BASE}/processing/config/<platform>.par."
echo "      2. Build a configuration file for the disambiguation engine as"
echo "         ${BASE}/processing/config/disam.par"
echo "      3. Edit the per-platform setup files in ${BASE}/processing/config."
echo "      4. Edit the platform specification file in ${BASE}/processing/config/${PROJECT}.psf"
echo "      5. Copy HIPS Vessel Configuration Files into ${BASE}/HDCS_Data/VesselConfig"
echo "      6. Use init_project to complete fieldsheet initialisation after you have"
echo "         examined the SDFs in ${BASE}/sdfs"
echo "      7. Execute ${BASE}/processing/init/makesheets.bat in a DOS window"
echo "         to make the CARIS fieldsheets"
if [ ${INITGUTM:-x} == "x" ]
then
	echo "      8. Make suitable SDF files in ${BASE}/processing/sdfs."
fi

END=`date --utc +"%H:%M:%S %d %b %Y"`
echo "$END: end setup_project: $*" >>./libccom.log

exit 0
